# Detect abandoned fishing gear and macroplastic with convolutional neural networks

This project aims to train a convolutional neural network that is capable to detect abandoned fishing gear and macroplastic on high-resolution satellite imagery in marine environments.

### Technical requirements

* Install python3
`brew install python3`

* Install [pipenv](https://pipenv.readthedocs.io/en/latest/)
`brew install pipenv`

* Install GDAL
`brew install gdal`

* Clone repository
`git clone git@github.com:twei55/gear-detector.git`

* Install project dependencies
`pipenv install`

### Possible issues

* Run `PIPENV_SKIP_LOCK=true pipenv install` if you run into issues that [locking packages idles forever](https://github.com/pypa/pipenv/issues/2200) ...

* Check your GDAL version with `gdalinfo --version` when installing dependencies fails and install the correct python package with `pipenv install gdal==2.4.2`. (Replace 2.4.2 with your version number if necessary)

* You might get a warning `pj_obj_create: Cannot find proj.db` when running the prediction. You can fix this by exporting the `PROJ_LIB` environment variable to point to the PROJ data directory. You can find the data directory by e.g. running `locate proj.db`.

## Preparation stage

### 1. Satellite imagery

* Preparation, training and test stages require appropriate satellite imagery from your preferred provider, so make sure to first request satellite data from your favorite provider before you start
*  Some public and commercial providers are listed below:
  * [Copernicus](https://earth.esa.int) (free)
  * [Landsat](https://landsat.gsfc.nasa.gov) (free)
  * [Planet Labs](https://www.planet.com) (commercial)
  * [DigitalGlobe](https://www.digitalglobe.com) (commercial)
  * [Airbus](http://www.intelligence-airbusds.com) (commercial)

### 2. Generate training / validation data from a GEOJSON file

* This stage assumes that you have GEOJSON file with a list of features with their corresponding geo position that you want to crop from satellite images for training or validation purposes

* Training data can be generated by running:

`PYTHONPATH=src pipenv run python src/training_data/image-crop.py`.

* The script takes a geojson file with positions of potential training features and crops images with a size of 42 x 42 px around the provided geo coordinates from the provided satellite images. The outcome may vary depending on the used images. 

Features should be stored in the following structure:

```
{
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [
          17.56533606744669,
          42.9315896181967,
          0
        ]
      },
      "properties": {
        "name": "fishpen_01"
      }
    }
  ]
}
```

The following variables for the preparation stage can be customised in src/config.ini:

```
[Training data]
cropped_training_data_path=./imagery/training_data/cropped/
geojson_file_path=./data/geo/geojson/*.geojson
satellite_imagery_path=./imagery/training_data/raw/*.tif
```

### 3. Generate training / validation data manually by retiling satellite images 

* Optionally you can extract training and validation features by retiling satellite images and selecting images manually

`python src/test_data/gdal_retile.py -targetDir imagery/training_data/cropped/[name] imagery/training_data/raw/[imagename].tif -ps 42 42`

* Find and label features in training and validation data

* Furthermore training data can be cropped using any GIS application (ArcGIS, QGIS).

### 4. Generate test data

* Crop satellite images into tiles that have the same size as the training data. This can be done with the help of [gdal_retile.py](http://www.gdal.org/gdal_retile.html).

* With the following command an image will be split into multiple images with a size of 42px x 42px.

```
python src/test_data/gdal_retile.py -targetDir imagery/test_data/cropped/planet/eddies/[name] imagery/test_data/raw/planet/eddies/[name]/[imagename].tif -ps 42 42
```

## Training stage

### 1. Train neural network with the provided training data

* The network training can be started by running:

```
PYTHONPATH=src pipenv run python src/convnet/image_classifier.py train
```

* The following variables for the training stage can be customised in src/config.ini:

```
[CNN Paths]
accuracy_log_path=./data/training/accuracy
model_path=./data/models/gear-cnn
predicted_imagery_path=./data/prediction/imagery
predicted_geodata_path=./data/prediction/geodata

[CNN Training]
image_bands=4
image_mode=RGBA
learning_rate=0.0005
epochs=30

[CNN Image data]
training_data=./imagery/training_data/classified
validation_data=./imagery/validation_data/classified
```

### 2. Resume training of an existing network

The training of a pretrained network can be resumed running:

```
PYTHONPATH=src pipenv run python src/convnet/image_classifier.py resume
```

The following variables for the prediction stage can be customised in src/config.ini:

```
[CNN Resume Training]
checkpoint=20180723_1320
epochs=10
```

The checkpoint is a timestamp that is appended to the model name in data/models. Whenever you start a training a new model is created. If you want to resume the training of a specific model, pick the corresponding timestamp and update the above mentioned part in src/config.ini.

## Prediction Stage

### 1. Use the trained neural network to classify provided test data

```
PYTHONPATH=src pipenv run python src/convnet/image_classifier.py predict
```

The following variables for the prediction stage can be customised in src/config.ini:

```
[CNN Prediction]
batch_size=250000
checkpoint=20180723_1320

[CNN Image data]
test_data=./imagery/test_data/cropped/process-data
```

The checkpoint is a timestamp that is appended to the model name 'gear-cnn' in `data/models`. Whenever you start a training a new model is created. If you want to use a trained model for a prediction, make sure to pick the correct timestamp and update the above mentioned part in `src/config.ini`.

Make sure your test images are located in a **subfolder** of the test_data folder referenced in `src/config.ini`.

**Wrong**

`./imagery/test_data/cropped/process-data/my-image-001.tif`

**Correct**

`./imagery/test_data/cropped/process-data/my-folder/my-image-001.tif`
