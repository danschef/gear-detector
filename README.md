# Detect abandoned fishing gear and macroplastic with convolutional neural networks

This project aims to train a convolutional neural network that is capable to detect abandoned fishing gear and macroplastic on high-resolution satellite imagery in marine environments.

## Preparation stage

### 1. Installation requirements

* Install GDAL
`brew install gdal`

* Install GDAL Python bindings
`pip install gdal`

* Install Rasterio
`pip install rasterio`

### 2. Satellite imagery

* Preparation, training and test stages require appropriate satellite imagery from your preferred provider, so make sure to first request satellite data from your favorite provider before you start
*  Some public and commercial providers are listed below:
  * [Copernicus](https://earth.esa.int) (free)
  * [Landsat](https://landsat.gsfc.nasa.gov) (free)
  * [Planet Labs](https://www.planet.com) (commercial)
  * [DigitalGlobe](https://www.digitalglobe.com) (commercial)
  * [Airbus](http://www.intelligence-airbusds.com) (commercial)

### 3. Generate training / validation data from a GEOJSON file

* This stage assumes that you have GEOJSON file with a list of features with their corresponding geo position that you want to crop from satellite images for training or validation purposes

* Training data can be generated by running:

`PYTHONPATH=src python src/training_data/image-crop.py`.

* The script takes a geojson file with positions of potential training features and crops images with a size of 42 x 42 px around the provided geo coordinates from the provided satellite images. The outcome may vary depending on the used images. 

Features should be stored in the following structure:

```
{
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [
          17.56533606744669,
          42.9315896181967,
          0
        ]
      },
      "properties": {
        "name": "fishpen_01"
      }
    }
  ]
}
```

The following variables for the preparation stage can be customised in src/config.ini:

```
[Training data]
cropped_training_data_path=./imagery/training_data/cropped/
geojson_file_path=./data/geo/geojson/*.geojson
satellite_imagery_path=./imagery/training_data/raw/*.tif
```

### 4. Generate training / validation data manually by retiling satellite images 

* Optionally you can extract training and validation features by retiling satellite images and selecting images manually

`python src/test_data/gdal_retile.py -targetDir imagery/training_data/cropped/[name] imagery/training_data/raw/[imagename].tif -ps 42 42`

* Find and label features in training and validation data

* Furthermore training data can cropped using any GIS application (ArcGIS, QGIS).

### 5. Generate test data

* Crop satellite images into tiles that have the same size as the training data. This can be done with the help of [gdal_retile.py](http://www.gdal.org/gdal_retile.html).

* With the following command an image will be split into multiple images with a size of 42px x 42px.

```
python src/test_data/gdal_retile.py -targetDir imagery/test_data/cropped/planet/eddies/[name] imagery/test_data/raw/planet/eddies/[name]/[imagename].tif -ps 42 42
```

## Training stage

### 1. Installation requirements

* Install pytorch

`pip install torch`

* Install Torchvision

`pip install torchvision`

* Install Numpy

`pip install numpy`

### 2. Train neural network with the provided training data

* The network training can be started by running:

```
PYTHONPATH=src python src/convnet/image_classifier.py train
```

* The following variables for the training stage can be customised in src/config.ini:

```
[CNN Paths]
accuracy_log_path=./data/training/accuracy
model_path=./data/models/gear-cnn
predicted_imagery_path=./data/prediction/imagery
predicted_geodata_path=./data/prediction/geodata

[CNN Training]
image_bands=4
image_mode=RGBA
learning_rate=0.0005
epochs=30

[CNN Image data]
training_data=./imagery/training_data/classified
validation_data=./imagery/validation_data/classified
```

### 3. Resume training of an existing network

The training of a pretrained network can be resumed running:

```
PYTHONPATH=src python src/convnet/image_classifier.py resume
```

The following variables for the prediction stage can be customised in src/config.ini:

```
[CNN Resume Training]
checkpoint=20180723_1320
epochs=10
```

## Prediction Stage

### 1. Use the trained neural network to classify provided test data

```
PYTHONPATH=src python src/convnet/image_classifier.py predict
```

The following variables for the prediction stage can be customised in src/config.ini:

```
[CNN Prediction]
batch_size=250000
checkpoint=20180723_1320

[CNN Image data]
test_data=./imagery/test_data/cropped/process-data
```
